<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room: {{ room_name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f5f5f5;
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chat-header {
            background-color: #3b82f6;
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }

        .connection-status {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #dc2626;
        }

        .status-indicator.connected {
            background-color: #22c55e;
        }

        #messages {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 70%;
            padding: 10px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
        }

        .message.left {
            align-self: flex-start;
            background-color: #e5e7eb;
        }

        .message.right {
            align-self: flex-end;
            background-color: #3b82f6;
            color: white;
        }

        .sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
            display: block;
        }

        .timestamp {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            display: block;
            text-align: right;
        }

        .input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background-color: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        #messageInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            outline: none;
        }

        #messageInput:focus {
            border-color: #3b82f6;
        }

        button {
            padding: 10px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #2563eb;
        }

        button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        .reconnecting-message {
            text-align: center;
            padding: 10px;
            background-color: #fef3c7;
            color: #92400e;
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>Chat Room: {{ room_name }}</h1>
            <div class="connection-status">
                <span class="status-indicator"></span>
                <span class="status-text">Connecting...</span>
            </div>
        </div>
        <div id="reconnecting-message" class="reconnecting-message">
            Connection lost. Attempting to reconnect...
        </div>
        <div id="messages"></div>
        <div class="input-container">
            <input type="text" id="messageInput" placeholder="Type your message..." disabled>
            <button onclick="sendMessage()" disabled>Send</button>
        </div>
    </div>

    <script>
        const token = "{{ access_token }}" || localStorage.getItem('access_token');
        const currentUserId = "{{ current_user_id }}";
        const roomName = "{{ room_name }}";

        if (!token) {
            alert('No access token found. Please sign in first.');
            window.location.href = '/api/auth/template/signin/';
        }

        let socket;
        let reconnectInterval;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_DELAY = 3000;

        const messageInput = document.getElementById('messageInput');
        const sendButton = document.querySelector('button');
        const statusIndicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.status-text');
        const reconnectingMessage = document.getElementById('reconnecting-message');

        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const host = window.location.host;
            const wsUrl = `${protocol}://${host}/ws/chat/${roomName}/?token=${token}`;
            console.log('Connecting to WebSocket URL:', wsUrl);
            return wsUrl;
        }

        function updateConnectionStatus(connected, message) {
            statusIndicator.classList.toggle('connected', connected);
            statusText.textContent = message;
            messageInput.disabled = !connected;
            sendButton.disabled = !connected;
            reconnectingMessage.style.display = connected ? 'none' : 'block';
        }

        function initializeWebSocket() {
            if (socket && socket.readyState !== WebSocket.CLOSED) {
                console.log('Socket is already open or connecting');
                return;
            }

            try {
                updateConnectionStatus(false, 'Connecting...');
                socket = new WebSocket(getWebSocketUrl());

                socket.onopen = function() {
                    console.log('WebSocket connection established');
                    reconnectAttempts = 0;
                    updateConnectionStatus(true, 'Connected');

                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };

                socket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        displayMessage(data);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                };

                socket.onclose = function(event) {
                    console.log('WebSocket closed:', event.code, event.reason);
                    updateConnectionStatus(false, 'Disconnected');

                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        console.log(`Reconnecting attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`);
                        setTimeout(initializeWebSocket, RECONNECT_DELAY);
                    } else {
                        updateConnectionStatus(false, 'Connection failed');
                        console.log('Max reconnection attempts reached');
                    }
                };

                socket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false, 'Connection error');
                };
            } catch (error) {
                console.error('Error initializing WebSocket:', error);
                updateConnectionStatus(false, 'Connection failed');
            }
        }

        function displayMessage(data) {
            const messages = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const isCurrentUser = String(data.user_id) === String(currentUserId);
            messageElement.classList.add(isCurrentUser ? 'right' : 'left');

            messageElement.innerHTML = `
                <span class="sender">${isCurrentUser ? 'You' : `User ${data.user_id}`}</span>
                ${data.message}
                <span class="timestamp">${new Date().toLocaleTimeString()}</span>
            `;

            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ message }));
                messageInput.value = '';
            }
        }

        messageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && (!socket || socket.readyState === WebSocket.CLOSED)) {
                console.log('Page visible, reconnecting WebSocket');
                reconnectAttempts = 0;
                initializeWebSocket();
            }
        });

        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.close();
            }
        });

        // Initialize WebSocket connection
        initializeWebSocket();
    </script>
</body>
</html>